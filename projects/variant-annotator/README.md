# Variant Annotator - A Helper Project

This project provides a Docker Compose environment for running services required to support variant annotation workflows, specifically for the [GA4GH Variation Representation Specification (VRS)](https://pypi.org/project/ga4gh.vrs/0.8.4/). VRS enables precise, computable, and standardized representation of genetic variation, including:

- Validation of variants against the reference genome
- Normalization and canonicalization of variant representations
- Interoperability between tools and databases using a common variant model

This environment is designed to facilitate integration with other NIAGADS genomics projects that require robust, reproducible, and standards-compliant variant annotation infrastructure.

> TODO: In addition to the Docker Compose environment, this project will later contain helper python scripts for annotating specific file types or specialized variant datasets generated by GCAD pipelines (e.g., hipFG standardized datasets, structural variant calls).

## Purpose

The main goal of this project is to define and orchestrate containers for:

- **UTA (Universal Transcript Archive)**: Provides transcript and alignment data for variant normalization and annotation.
- **SeqRepo**: Offers fast, local access to biological sequence data, required for VRS-based normalization and annotation.

These services are essential for tools and APIs that implement or depend on GA4GH VRS, enabling consistent and reproducible variant representation.

This project is intended to be used as a dependency by other projects in the `niagads-pylib` monorepo, including:

- `genomicsdb-loader`: ETL plugins that require GA4GH standardized variant or sequence identifiers
- `open-access-api` (TBD)

## Installation

If you are working within the `niagads-pylib` monorepo, the `variant-annotator` project is already part of the repository. Simply navigate to the project directory:

```bash
cd projects/variant-annotator
```

Alternatively, if you want to use the `variant-annotator` as a standalone project, you can clone only this directory using Git sparse checkout:

```bash
git clone <repo-url>
cd niagads-pylib
git sparse-checkout init --cone
git sparse-checkout set projects/variant-annotator
cd projects/variant-annotator
```

Once inside the `variant-annotator` directory, follow the configuration and service execution instructions below.

### Configuration

Copy `sample.env` to `.env`.  **If working within the `niagads-pylib` monorepo, please COPY the file; DO NOT RENAME to avoid accidentally removing `sample.env` from the repository.**

- Modify the following values in the `.env` as needed for your system:

  - `HOST_SEQREPO_DATA_DIR`: Absolute path to the SeqRepo data directory on the host machine. This directory contains the biological sequence data required by the SeqRepo services.
  - `HOST_UTA_DATA_DIR`: Absolute path to the UTA data directory on the host machine. This directory stores the PostgreSQL database files for the UTA service.
  - `HOST_SEQREPO_SERVICE_PORT`: The port on the host machine to bind the SeqRepo REST service. Default is `5000`.
  - `HOST_UTA_SERVICE_PORT`: The port on the host machine to bind the UTA service. Default is `5432`.
  - `UTA_PGADMIN_PWD`: The password for the PostgreSQL database used by the UTA service. You can replace `UtaVar1a` with a secure password or leave as is if service is only deployed locally.

### Run the Services

Run `docker-compose up -d` in this directory to launch all services.

The `docker-compose.yaml` defines the following services:

1. **SeqRepo**:
   - Provides access to biological sequence data required for variant normalization and annotation.
   - One-off service to retrieve version seqrepo version specified by the image (`2024-12-20`) and install locally.
   - Data is stored in the directory specified by the `HOST_SEQREPO_DATA_DIR` environment variable.

2. **SeqRepo REST Service**:
   - A RESTful API for accessing locally stored SeqRepo data.  Service URL will be passed as a parameter to any ETL plugin that uses GA4GH VRS.
   - Runs on the port specified by the `HOST_SEQREPO_SERVICE_PORT` environment variable (default: 5000).
   - Depends on the SeqRepo service for initializing service data repository.
   - Test: `curl http://localhost:5000/seqrepo/1/sequence/refseq:NM_000551.3`

3. **UTA (Universal Transcript Archive)**:
   - Provides transcript and alignment data for variant normalization and annotation.
   - PostgresSQL data volume is mounted in the directory specified by the `HOST_UTA_DATA_DIR` environment variable.
   - Runs on the port specified by the `HOST_UTA_SERVICE_PORT` environment variable (default: 5432). Recommend changing this value as it is likely that the ETL target database will also be on port 5432.
   - Test (assuming psql installed on system): `psql -XAt postgres://anonymous@localhost/uta -c 'select count(*) from uta_20241220.transcript'` (expect 314227)

### System Clean-up and Monitoring

The `seqrepo` service is used to download and install the SeqRepo data. This service only needs to be run once. After the data is downloaded and installed, the container and image can be removed to free up resources.

To remove the container and image:

   ```bash
   docker rm variant-annotator-seqrepo
   docker rmi biocommons/seqrepo:2024-12-20
   ```

#### Monitor Idle Containers (MIC)

The `monitor_idle_containers.sh` script is a utility used to monitor Docker containers for inactivity and stop them if they remain idle for a specified period. This helps manage resource usage and ensures that idle containers do not consume unnecessary resources.  

> This is a script that has been generalized for other applications.

> TODO: move into planned monorepo `bash` library

- Specifically monitors the `seqrepo-rest-service` and `uta` containers for network activity.
- Stops these containers if they remain idle for a configurable timeout period.
- Provides command-line flags to customize idle timeout, check interval, and the list of containers to monitor.

##### MIC Usage

Run the script with the desired options. Defaults are provided if no options are specified.

```bash
./monitor_idle_containers.sh [OPTIONS]
```

- `--days <number>`: Set the idle timeout in days (default: 2).
- `--check-interval <seconds>`: Set the interval in seconds to check for idle containers (default: 3600 seconds).
- `--containers <list>`: Comma-separated list of container names to monitor (default: `seqrepo,seqrepo-rest-service,uta`).
- `--help`: Display the help message and exit.

To run the script in the background and monitor `seqrepo` and `uta` containers with a 3-day idle timeout and a 2-hour check interval:

```bash
nohup ./monitor_idle_containers.sh --days 3 --check-interval 7200 --containers "seqrepo,uta" > monitor_idle.log 2>&1 &
```

## References

- [GA4GH VRS PyPI](https://pypi.org/project/ga4gh.vrs/0.8.4/)
- [UTA Documentation](https://github.com/biocommons/uta)
- [SeqRepo Documentation](https://github.com/biocommons/seqrepo)
